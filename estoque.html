<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Estoque</title>

  <link rel="stylesheet" href="estoque.css?v=5" />

  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
</head>

<body>
  <div id="page-loader" aria-hidden="true">
    <div class="pl-card">
      <div class="pl-spinner"></div>
      <p>Carregando‚Ä¶</p>
    </div>
  </div>

  <div class="mobile-topbar" role="banner">
    <button id="btnMobileMenu" class="hamburger" aria-label="Abrir menu" aria-controls="sidebar" aria-expanded="false">
      <span></span>
    </button>
    <strong class="mt-title">Estoque</strong>
    <a class="mt-action" href="./index.html" data-loader="true" aria-label="Ir para Empr√©stimo">
      <img src="https://img.icons8.com/ios-glyphs/24/000000/paint-bucket.png" alt="">
    </a>
  </div>

  <div id="sidebarOverlay" class="sidebar-overlay" hidden></div>

  <div class="dashboard-container">
    <nav class="sidebar" id="sidebar" aria-label="Menu lateral">
      <div class="sidebar-header">
        <img src="./img/logo_bossa.png" alt="Logo Bossa" class="sidebar-logo" />
        <span class="sidebar-title">Bossa Almoxarifado</span>
      </div>

      <ul class="sidebar-menu">
        <li>
          <a href="./index.html" data-loader="true">
            <img src="https://img.icons8.com/ios-glyphs/30/a1a1a1/home.png" alt="home" />
            <span>In√≠cio</span>
          </a>
        </li>
        <li class="active">
          <a href="./estoque.html" data-loader="true">
            <img src="https://img.icons8.com/ios-glyphs/30/a1a1a1/box.png" alt="box" />
            <span>Estoque</span>
          </a>
        </li>
        <li>
          <a href="./index.html" data-loader="true">
            <img src="https://img.icons8.com/ios-glyphs/30/a1a1a1/paint-bucket.png" alt="paint-bucket" />
            <span>Emprestimo</span>
          </a>
        </li>
      </ul>

      <div class="sidebar-quick" data-mobile-only>
        <h4>A√ß√µes</h4>
        <a href="#" id="botao-adicionar-nf_mobile" class="quick-link">Adicionar por NF</a>
        <a href="#" id="botao-exportar-importar_mobile" class="quick-link">Exportar/Importar</a>
        <a href="#" id="toggleButton_mobile" class="quick-link">Adicionar Produto</a>
        <a href="#" id="toggleCategoriaBtn_mobile" class="quick-link">Cadastrar Categoria</a>
      </div>

      <div class="sidebar-footer">
        <div class="user-profile" id="userProfile">
          <img src="./img/icon-img.webp" alt="√çcone do Usu√°rio" class="user-avatar" />
          <span class="user-name">Usu√°rio</span>
        </div>

        <div class="logout-link" id="logoutLink">
          <a href="login.html">
            <img src="https://img.icons8.com/ios-glyphs/24/555555/exit.png" alt="Sair">
            <span>Sair</span>
          </a>
        </div>
      </div>
    </nav>

    <main class="main-content">
      <div class="main-header-actions">
        <div class="search-container">
         <img class="icone-busca" src="./img/icone_lupa.png" alt="Buscar" />
          <input type="text" id="busca-geral" placeholder="Buscar produtos por nome, categoria ou subcategoria..." />
        </div>

        <button class="botao-acao" id="botao-adicionar-nf">
          <img src="https://img.icons8.com/ios-glyphs/24/000000/camera.png" alt="NF" />
          <span>Adicionar por NF</span>
        </button>

        <button class="botao-acao" id="botao-exportar-importar">
          <img src="https://img.icons8.com/ios-glyphs/24/000000/synchronize.png" alt="Exportar/Importar" />
          <span>Exportar/Importar</span>
        </button>

        <button id="toggleButton" class="botao-destaque-adicionar">
          <img src="https://img.icons8.com/ios-glyphs/24/ffffff/plus.png" alt="Adicionar" />
          <span>Adicionar Produto</span>
        </button>

        <button id="toggleCategoriaBtn" class="botao-destaque-adicionar">
          <img src="https://img.icons8.com/ios-glyphs/24/ffffff/plus.png" alt="Categoria" />
          <span>Cadastrar Categoria</span>
        </button>
      </div>

      <section class="input-container"></section>

      <div id="modal-categoria" class="modal-categoria-overlay" style="display:none;">
        <div class="modal-categoria-content">
          <h2>Cadastrar Categoria</h2>

          <label for="nova-categoria">Categoria:</label>
          <input type="text" id="nova-categoria" placeholder="Ex: El√©trica, Hidr√°ulica..." />

          <label>Subcategoria:</label>
          <div id="subcategorias-container">
            <div class="subcategoria-item">
              <input type="text" class="nova-subcategoria" placeholder="Ex: Fios, Tomadas..." />
              <button type="button" class="remover-subcategoria" title="Remover">üóëÔ∏è</button>
            </div>
          </div>

          <button id="adicionar-subcategoria" type="button" class="btn-add-sub">
            <span class="plus">+</span> Adicionar Subcategoria
          </button>

          <div class="modal-categoria-actions">
            <button id="cancelar-categoria" type="button" class="btn-cancelar">Cancelar</button>
            <button id="salvar-categoria" type="button" class="btn-salvar">Salvar</button>
          </div>
        </div>
      </div>

      <div class="table-header">
        <span id="contador-texto" class="contador-produtos">0 produtos</span>

        <div class="acoes-ordenar">
          <button id="botao-ordenar" class="botao-acao">
            <img src="https://img.icons8.com/ios-glyphs/30/a1a1a1/sort.png" alt="sort" />
            <span>Mais novo</span>
          </button>

          <button id="filtrar-btn" class="botao-acao">Filtrar</button>
        </div>
      </div>

      <div id="acoes-selecao-bar" class="acoes-selecao-bar"></div>

      <div id="card-grid-container" class="card-grid-container"></div>

      <div id="paginacao-container"></div>
    </main>
  </div>

  <div id="filtro-overlay" class="filtro-overlay"></div>
  <div id="filtro-panel" class="filtro-panel">
    <div class="filtro-header">
      <h2>Filtrar por</h2>
      <button id="fechar-filtro" aria-label="Fechar filtros">&times;</button>
    </div>

    <div class="filtro-conteudo">
      <h3>Categoria</h3>
      <select id="filtro-categoria">
        <option value="">Todas</option>
      </select>

      <h3>Subcategoria</h3>
      <select id="filtro-subcategoria">
        <option value="">Todas</option>
      </select>
    </div>

    <div class="filtro-footer">
      <button id="aplicar-filtro" class="botao-destaque-adicionar">Aplicar Filtro</button>
      <button id="limpar-filtro" class="botao-acao">Limpar</button>
    </div>
  </div>

  <div id="modal-produto" class="modal-produto-overlay" style="display:none;">
    <div class="modal-produto-content">
      <h2>Adicionar Produto</h2>

      <label for="produto-nome">Nome:</label>
      <input type="text" id="produto-nome" placeholder="Ex: Martelo, Parafuso...">

      <label for="produto-quantidade">Quantidade:</label>
      <input type="number" id="produto-quantidade" placeholder="Ex: 10">

      <label for="produto-categoria">Categoria:</label>
      <select id="produto-categoria"></select>

      <label for="produto-subcategoria">Subcategoria:</label>
      <select id="produto-subcategoria"></select>

      <label for="produto-data">Data de Entrada:</label>
      <input type="date" id="produto-data">

      <label for="produto-imagem">Imagem:</label>
      <input type="file" id="produto-imagem" accept="image/*">

      <div class="modal-produto-actions">
        <button id="cancelar-produto" class="btn-cancelar">Cancelar</button>
        <button id="salvar-produto" class="btn-salvar">Salvar</button>
      </div>
    </div>
  </div>

  <div id="modal-editar-produto" class="modal-produto-overlay" style="display:none;">
    <div class="modal-produto-content">
      <h2>Editar Produto</h2>

      <input type="hidden" id="editar-id">

      <label for="editar-nome">Nome:</label>
      <input type="text" id="editar-nome" placeholder="Ex: Martelo, Parafuso...">

      <label for="editar-quantidade">Quantidade:</label>
      <input type="number" id="editar-quantidade">

      <label for="editar-categoria">Categoria:</label>
      <select id="editar-categoria"></select>

      <label for="editar-subcategoria">Subcategoria:</label>
      <select id="editar-subcategoria"></select>

      <label for="editar-data">Data de Entrada:</label>
      <input type="date" id="editar-data">

      <label for="editar-imagem">Imagem:</label>
      <input type="file" id="editar-imagem" accept="image/*">

      <div class="modal-produto-actions">
        <button id="cancelar-editar" class="btn-cancelar">Cancelar</button>
        <button id="salvar-editar" class="btn-salvar">Salvar</button>
      </div>
    </div>
  </div>

  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js')
        .then(() => console.log('Service Worker registrado com sucesso'))
        .catch(err => console.log('Erro ao registrar Service Worker', err));
    }
  </script>

  <script src="estoque.js?v=4" defer></script>

  <script>
    (function initPageLoader() {
      const loader = document.getElementById('page-loader');
      if (!loader) return;

      const MIN_MS = 500;
      const start = Date.now();
      loader.classList.add('show');
      window.addEventListener('load', () => {
        const elapsed = Date.now() - start;
        const delay = Math.max(0, MIN_MS - elapsed);
        setTimeout(() => loader.classList.remove('show'), delay);
      });

      const isMod = (e) => e.button !== 0 || e.metaKey || e.ctrlKey || e.shiftKey || e.altKey;
      const shouldBypass = (a) => {
        const href = a.getAttribute('href') || '';
        if (!href) return true;
        if (href.startsWith('#') || href.startsWith('javascript:')) return true;
        if (a.target && a.target.toLowerCase() === '_blank') return true;
        if (a.hasAttribute('download')) return true;
        const u = new URL(href, location.href);
        if (u.protocol === 'mailto:' || u.protocol === 'tel:') return true;
        if (u.origin !== location.origin) return true;
        return false;
      };
      const isSameDoc = (url) => {
        const u = new URL(url, location.href);
        return u.origin === location.origin &&
               u.pathname.replace(/\/+$/, '') === location.pathname.replace(/\/+$/, '') &&
               (u.search || '') === (location.search || '');
      };

      document.addEventListener('click', (e) => {
        const a = e.target.closest('a[href]');
        if (!a) return;
        if (isMod(e)) return;
        if (shouldBypass(a)) return;
        if (isSameDoc(a.href)) return;
        e.preventDefault();
        loader.classList.add('show');
        setTimeout(() => { window.location.href = a.href; }, 150);
      }, true);

      window.addEventListener('beforeunload', () => {
        loader.classList.add('show');
      });
    })();
  </script>

  <script>
    (function () {
      const btn = document.getElementById('btnMobileMenu');
      const overlay = document.getElementById('sidebarOverlay');
      const body = document.body;

      function openMenu() {
        body.classList.add('sidebar-open');
        btn.setAttribute('aria-expanded', 'true');
        overlay.hidden = false;
      }
      function closeMenu() {
        body.classList.remove('sidebar-open');
        btn.setAttribute('aria-expanded', 'false');
        overlay.hidden = true;
      }

      btn?.addEventListener('click', () => {
        if (body.classList.contains('sidebar-open')) closeMenu(); else openMenu();
      });
      overlay?.addEventListener('click', closeMenu);

      // fecha ao navegar por links do menu (mobile)
      document.querySelectorAll('.sidebar a[href]').forEach(a => {
        a.addEventListener('click', () => closeMenu());
      });
    })();
  </script>
</body>

</html>
